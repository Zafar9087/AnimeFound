<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="Flux_Dev_Logo_design_for_AnimeFound_sleek_and_modern_dark_blue_2.png">
  <title>Anime Card</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0a0f1a 0%, #11294d 100%);
      color: #e0e6f7;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .anime-card-balanced {
      display: flex;
      align-items: stretch;
      background: rgba(17, 24, 39, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(77, 166, 255, 0.2);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 900px;
      height: auto;
      min-height: 500px;
      overflow: hidden;
      margin: 0 auto;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .anime-card-balanced:hover {
      box-shadow: 0 12px 40px rgba(77, 166, 255, 0.2);
      transform: translateY(-5px);
    }
    .anime-card-img {
      width: 380px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .anime-card-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease-out;
    }
    .anime-card-img:hover img {
      transform: scale(1.05);
    }
    .anime-card-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: center;
    }
    .anime-card-title {
      font-size: 2.4em;
      font-weight: 700;
      color: #fff;
      margin: 0;
      text-shadow: 0 2px 8px rgba(77, 166, 255, 0.3);
      letter-spacing: 1px;
    }
    .anime-card-desc {
      font-size: 1.05em;
      color: #c0c8e7;
      line-height: 1.6em;
      border-left: 3px solid #4da6ff;
      padding-left: 16px;
      max-height: 180px;
      overflow-y: auto;
    }
    .anime-card-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .badge {
      background: rgba(77, 166, 255, 0.15);
      border: 1px solid rgba(77, 166, 255, 0.3);
      color: #e0e6f7;
      padding: 8px 16px;
      font-size: 0.95em;
      border-radius: 30px;
      font-weight: 500;
    }
    .action-buttons {
      display: flex;
      gap: 15px; /* Increased gap */
      margin-top: 20px;
      align-items: center;
    }
    .list-btn {
      background: rgba(77, 166, 255, 0.15);
      border: 1px solid rgba(77, 166, 255, 0.3);
      color: #e0e6f7;
      border-radius: 50%; /* Circle shape */
      font-size: 1.5em; /* Larger icon size */
      width: 50px;
      height: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .list-btn:hover {
      background: rgba(77, 166, 255, 0.3);
      transform: translateY(-2px);
    }
    .list-btn.active {
      background: #4da6ff;
      color: #fff;
      border-color: #4da6ff;
    }
    .watch-btn {
      background: linear-gradient(90deg, #4da6ff 0%, #1c75d8 100%);
      color: #fff;
      text-decoration: none;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      padding: 14px 36px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(77, 166, 255, 0.2);
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .watch-btn:hover {
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 20px rgba(77, 166, 255, 0.4);
    }
    .user-actions.hidden {
      display: none;
    }
    @media (max-width: 900px) {
      body { padding: 0; }
      .anime-card-balanced {
        flex-direction: column;
        width: 100%;
        height: auto;
        min-height: 100vh;
        border-radius: 0;
        box-shadow: none;
        border: none;
      }
      .anime-card-img { width: 100%; height: 300px; }
      .anime-card-content { padding: 24px; }
      .anime-card-title { font-size: 1.8em; }
      .anime-card-desc { font-size: 1em; max-height: 150px; }
      .action-buttons { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="anime-card-balanced" id="animeCard">
    <div class="anime-card-img">
      <img id="animeImg" src="" alt="Anime Poster">
    </div>
    <div class="anime-card-content">
      <h2 class="anime-card-title" id="animeTitle"></h2>
      <p class="anime-card-desc" id="animeDesc"></p>
      <div class="anime-card-badges">
        <span class="badge" id="animeYear"></span>
        <span class="badge" id="animeEpisodes"></span>
        <span class="badge" id="animeScore"></span>
      </div>
      <div class="action-buttons">
        <a class="watch-btn" id="watchBtn" href="#" target="_blank">Смотреть аниме</a>
        <div id="userActions" class="user-actions hidden">
            <button class="list-btn" id="favoriteBtn" data-status="favorited" title="В избранное">❤️</button>
            <button class="list-btn" id="watchingBtn" data-status="watching" title="Смотрю">▶️</button>
            <button class="list-btn" id="planBtn" data-status="plan-to-watch" title="Запланировать">➕</button>
            <button class="list-btn" id="watchedBtn" data-status="watched" title="Просмотрено">✅</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // --- 1. Get Anime Info from URL ---
      const params = new URLSearchParams(window.location.search);
      const animeId = params.get('id'); // IMPORTANT: We need a unique ID
      const title = params.get('title') || 'Название не найдено';
      const desc = params.get('desc') || 'Описание отсутствует.';
      const img = params.get('img') || '';
      const year = params.get('year');
      const episodes = params.get('episodes');
      const score = params.get('score');

      // --- 2. Populate Card with Anime Info ---
      document.getElementById('animeTitle').textContent = title;
      document.getElementById('animeDesc').textContent = desc;
      document.getElementById('animeImg').src = img;
      document.getElementById('animeImg').alt = title;

      const yearBadge = document.getElementById('animeYear');
      const episodesBadge = document.getElementById('animeEpisodes');
      const scoreBadge = document.getElementById('animeScore');

      if (year) yearBadge.textContent = year; else yearBadge.style.display = 'none';
      if (episodes) episodesBadge.textContent = `${episodes} эп.`; else episodesBadge.style.display = 'none';
      if (score) scoreBadge.textContent = `⭐ ${score}`; else scoreBadge.style.display = 'none';
      
      // Setup watch button link
      const watchBtn = document.getElementById('watchBtn');
      watchBtn.href = `https://yandex.ru/search/?text=${encodeURIComponent(title + ' смотреть аниме')}`;


      // --- 3. Handle User Authentication and Progress ---
      let user = null;
      try {
        const userRes = await fetch('/api/user');
        if (userRes.ok) {
          user = await userRes.json();
        }
      } catch (e) {
        console.error("Error fetching user:", e);
      }

      if (user && animeId) {
        document.getElementById('userActions').classList.remove('hidden');
        
        // Also mark as "watching" when the main watch button is clicked
        watchBtn.addEventListener('click', () => {
            updateAnimeStatus(animeId, 'watching');
        });

        // Fetch user's list and update button states
        const listRes = await fetch('/api/user/animelist');
        const userAnimeList = await listRes.json();
        const statusForThisAnime = userAnimeList.filter(item => item.anime_id === animeId);

        const buttons = document.querySelectorAll('.list-btn');
        buttons.forEach(btn => {
            const status = btn.dataset.status;
            if (statusForThisAnime.some(item => item.status === status)) {
                btn.classList.add('active');
            }

            btn.addEventListener('click', async () => {
                const currentStatus = btn.classList.contains('active') ? 'none' : status;
                await updateAnimeStatus(animeId, currentStatus, status);
                btn.classList.toggle('active');
            });
        });
      }
    });

    async function updateAnimeStatus(animeId, newStatus, oldStatus = null) {
        try {
            const res = await fetch('/api/user/animelist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    anime_id: animeId,
                    status: newStatus,
                    old_status: oldStatus // Required by backend for 'none' status
                }),
            });
            if (!res.ok) {
                console.error("Failed to update status");
                // Optional: revert UI change on failure
            }
        } catch (err) {
            console.error("Error updating status:", err);
        }
    }
  </script>
</body>
</html>