<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="Flux_Dev_Logo_design_for_AnimeFound_sleek_and_modern_dark_blue_2.png"> <!-- Оставляем PNG для Apple -->
  <title>Anime Card</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0a0f1a 0%, #11294d 100%);
      color: #e0e6f7;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .anime-card-balanced {
      display: flex;
      align-items: stretch;
      background: rgba(17, 24, 39, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(77, 166, 255, 0.2);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 900px;
      height: auto;
      min-height: 500px;
      overflow: hidden;
      margin: 0 auto;
      transition: box-shadow 0.3s, transform 0.3s;
    }
    .anime-card-balanced:hover {
      box-shadow: 0 12px 40px rgba(77, 166, 255, 0.2);
      transform: translateY(-5px);
    }
    .anime-card-img {
      width: 380px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .anime-card-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease-out;
    }
    .anime-card-img:hover img {
      transform: scale(1.05);
    }
    .anime-card-content {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      justify-content: center;
    }
    .anime-card-title {
      font-size: 2.4em;
      font-weight: 700;
      color: #fff;
      margin: 0;
      text-shadow: 0 2px 8px rgba(77, 166, 255, 0.3);
      letter-spacing: 1px;
    }
    .anime-card-desc {
      font-size: 1.05em;
      color: #c0c8e7;
      line-height: 1.6em;
      border-left: 3px solid #4da6ff;
      padding-left: 16px;
      max-height: 180px;
      overflow-y: auto;
    }
    .anime-card-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .badge {
      background: rgba(77, 166, 255, 0.15);
      border: 1px solid rgba(77, 166, 255, 0.3);
      color: #e0e6f7;
      padding: 8px 16px;
      font-size: 0.95em;
      border-radius: 30px;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: background 0.2s, color 0.2s;
    }
    .badge:hover {
      background: rgba(77, 166, 255, 0.3);
      color: #fff;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      align-self: flex-start;
    }
    .list-btn {
      background: rgba(77, 166, 255, 0.15);
      border: 1px solid rgba(77, 166, 255, 0.3);
      color: #e0e6f7;
      border-radius: 12px;
      font-size: 0.9em;
      padding: 12px 18px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.3s ease;
    }
    .list-btn:hover {
      background: rgba(77, 166, 255, 0.3);
    }
    .list-btn.active { background: #4da6ff; color: #fff; }
    .watch-btn {
      background: linear-gradient(90deg, #4da6ff 0%, #1c75d8 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      padding: 14px 36px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(77, 166, 255, 0.2);
      transition: all 0.3s ease;
      align-self: flex-start;
      letter-spacing: 0.5px;
    }
    .watch-btn:hover {
      background: linear-gradient(90deg, #1c75d8 0%, #4da6ff 100%);
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 20px rgba(77, 166, 255, 0.4);
    }
    @media (max-width: 900px) {
      body {
        padding: 0;
      }
      .anime-card-balanced {
        flex-direction: column;
        width: 98vw;
        height: auto;
        min-height: 0;
        border-radius: 0;
        box-shadow: none;
        border: none;
      }
      .anime-card-img {
        width: 100%;
        height: 300px;
      }
      .anime-card-content {
        padding: 24px;
      }
      .anime-card-title {
        font-size: 1.8em;
      }
      .anime-card-desc {
        font-size: 1em;
        max-height: 150px;
      }
      .watch-btn {
        align-self: stretch;
        text-align: center;
      }
      .action-buttons {
        align-self: stretch;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="anime-card-balanced" id="animeCard">
    <div class="anime-card-img">
      <img id="animeImg" src="" alt="Anime Poster">
    </div>
    <div class="anime-card-content">
      <h2 class="anime-card-title" id="animeTitle"></h2>
      <p class="anime-card-desc" id="animeDesc"></p>
      <div class="anime-card-badges">
        <span class="badge" id="animeYear"></span>
        <span class="badge" id="animeEpisodes"></span>
        <span class="badge" id="animeScore"></span>
      </div>
      <div class="action-buttons">
        <button class="watch-btn" id="watchBtn">Смотреть аниме</button>
        <button class="list-btn" id="favoriteBtn" style="display: none;">❤️ Favorite</button>
        <button class="list-btn" id="watchingBtn" style="display: none;">▶️ Watching</button>
        <button class="list-btn" id="planBtn" style="display: none;">+ Plan to Watch</button>
        <button class="list-btn" id="watchedBtn" style="display: none;">✅ Watched</button>
      </div>
    </div>
  </div>

  <script>
    // Получаем параметры из URL
    const params = new URLSearchParams(window.location.search);
    const title = params.get('title') || 'Название не найдено';
    const desc = params.get('desc') || 'Описание отсутствует.';
    const img = params.get('img') || '';
    const year = params.get('year');
    const episodes = params.get('episodes');
    const score = params.get('score');

    document.getElementById('animeTitle').textContent = title;
    document.getElementById('animeDesc').textContent = desc;
    document.getElementById('animeImg').src = img;
    document.getElementById('animeImg').alt = title;

    const yearBadge = document.getElementById('animeYear');
    const episodesBadge = document.getElementById('animeEpisodes');
    const scoreBadge = document.getElementById('animeScore');

    if (year) {
      yearBadge.textContent = year;
    } else {
      yearBadge.style.display = 'none';
    }

    if (episodes) {
      episodesBadge.textContent = `${episodes} эп.`;
    } else {
      episodesBadge.style.display = 'none';
    }

    if (score) {
      scoreBadge.textContent = `⭐ ${score}`;
    } else {
      scoreBadge.style.display = 'none';
    }

    // Logic for adding to lists
    const user = JSON.parse(localStorage.getItem('googleUser'));
    if (user) {
      const favoriteBtn = document.getElementById('favoriteBtn');
      const watchingBtn = document.getElementById('watchingBtn');
      const planBtn = document.getElementById('planBtn');
      const watchedBtn = document.getElementById('watchedBtn');

      const buttons = {
        favorites: favoriteBtn,
        watching: watchingBtn,
        planToWatch: planBtn,
        watched: watchedBtn
      };

      let userProfile = JSON.parse(localStorage.getItem(user.sub)) || { xp: 0, favorites: [], planToWatch: [], watching: [], watched: [] };

      favoriteBtn.style.display = 'block';
      watchingBtn.style.display = 'block';
      planBtn.style.display = 'block';
      watchedBtn.style.display = 'block';

      const animeData = { title, img, desc, episodes, score, year };

      function updateButtonStates() {
        for (const listName in buttons) {
            if (userProfile[listName] && userProfile[listName].some(item => item.title === animeData.title)) {
                buttons[listName].classList.add('active');
            } else {
                buttons[listName].classList.remove('active');
            }
        }
      }

      function addToList(listName, xpGain) {
        
        // Check if anime is already in the list to avoid duplicates
        const list = userProfile[listName];
        if (!list.some(item => item.title === animeData.title)) {
            list.push(animeData);
            if (xpGain) {
                userProfile.xp += xpGain;
            }
            localStorage.setItem(user.sub, JSON.stringify(userProfile));
            alert(`Added "${animeData.title}" to your "${listName}" list!`);
        } else {
            // If it's already there, remove it
            userProfile[listName] = list.filter(item => item.title !== animeData.title);
            localStorage.setItem(user.sub, JSON.stringify(userProfile));
        }
      }

      favoriteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        addToList('favorites', 10);
      });

      watchingBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        addToList('watching', 10);
      });

      planBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        addToList('planToWatch', 5);
      });

      watchedBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        addToList('watched', 5);
      });

      updateButtonStates();

    } else {
        // Hide buttons if user is not logged in
        const favoriteBtn = document.getElementById('favoriteBtn');
        const watchingBtn = document.getElementById('watchingBtn');
        const planBtn = document.getElementById('planBtn');
        const watchedBtn = document.getElementById('watchedBtn');
        favoriteBtn.style.display = 'none';
        watchingBtn.style.display = 'none';
        planBtn.style.display = 'none';
        watchedBtn.style.display = 'none';
    }

    // Кнопка "Смотреть аниме"
    document.getElementById('watchBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      if(user){
        addToList('watching', 10);
      }
      const isRussian = /[а-яА-ЯЁё]/.test(desc);
      if (isRussian) {
        const russianChars = {
            'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh',
            'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
            'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'h', 'ц': 'c',
            'ч': 'ch', 'ш': 'sh', 'щ': 'shch', 'ь': '', 'ы': 'y', 'ъ': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
        };
        function slugify(str) {
            return str.toLowerCase().split('').map(char => russianChars[char] || char)
            .join('')
            .replace(/[^a-z0-9\s-]/gi, '')
            .trim()
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
        }
        // We need the original title for the slug, which isn't passed to card.html.
        // We will use the Russian title as a fallback for search.
        const animeLink = `https://anilibria.wiki/release/${slugify(title)}.html`;
        window.location.href = `choose.html?anime=${encodeURIComponent(title)}&animeLink=${encodeURIComponent(animeLink)}&lang=ru`;
      } else {
        // English
        window.location.href = `chooseeng.html?anime=${encodeURIComponent(title)}`;
      }
    });

  </script>
</body>
</html>